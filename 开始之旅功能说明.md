# 开始之旅功能说明

## 功能概述

"开始之旅"是减肥打卡微信小程序中的一个**里程碑庆祝系统**，旨在通过阶段性成就庆祝来激励用户坚持减肥计划。

## 功能位置

- **主要组件**: `components/user-progress/user-progress.js`
- **界面文件**: `components/user-progress/user-progress.wxml`
- **样式文件**: `components/user-progress/user-progress.wxss`

## 里程碑节点

系统定义了以下里程碑节点：

| 天数 | 里程碑标题 | 描述 |
|------|------------|------|
| 第1天 | 开始之旅 | 恭喜你开始了减肥之旅！继续保持！ |
| 第7天 | 一周达人 | 坚持一周了！你已经养成了好习惯！ |
| 第14天 | 双周坚持 | 两周的坚持，太棒了！目标就在前方！ |
| 第30天 | 月度冠军 | 坚持一个月！你已经成为更好的自己！ |
| 第60天 | 双月英雄 | 60天的坚持！你的毅力令人敬佩！ |
| 第100天 | 百日达人 | 100天！你创造了属于自己的奇迹！ |

## 技术实现

### 1. 天数计算逻辑

```javascript
// 计算减肥计划开始天数
calculatePersistenceDays(userInfo) {
  // 获取计划开始日期，如果没有则使用今天
  const planStartDate = userInfo.planStartDate || app.formatDate(new Date());
  const startDate = new Date(planStartDate);
  const today = new Date();
  
  // 设置时间为同一天的开始时间，避免时间差影响天数计算
  startDate.setHours(0, 0, 0, 0);
  today.setHours(0, 0, 0, 0);
  
  // 计算天数差（包括开始当天）
  const timeDiff = today.getTime() - startDate.getTime();
  const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1;
  
  return Math.max(1, daysDiff);
}
```

### 2. 里程碑检测

```javascript
// 里程碑检测
checkMilestones(persistenceDays) {
  const milestones = [
    { day: 1, title: '开始之旅', desc: '恭喜你开始了减肥之旅！继续保持！' },
    { day: 7, title: '一周达人', desc: '坚持一周了！你已经养成了好习惯！' },
    { day: 14, title: '双周坚持', desc: '两周的坚持，太棒了！目标就在前方！' },
    { day: 30, title: '月度冠军', desc: '坚持一个月！你已经成为更好的自己！' },
    { day: 60, title: '双月英雄', desc: '60天的坚持！你的毅力令人敬佩！' },
    { day: 100, title: '百日达人', desc: '100天！你创造了属于自己的奇迹！' }
  ];

  for (const milestone of milestones) {
    if (persistenceDays === milestone.day) {
      // 特殊处理第1天的里程碑，只显示一次
      if (milestone.day === 1) {
        if (!this.data.hasShownFirstDayMilestone) {
          this.showMilestoneCelebration(milestone);
          this.setData({ 
            lastMilestoneDay: milestone.day,
            hasShownFirstDayMilestone: true 
          });
        }
      } else {
        this.showMilestoneCelebration(milestone);
        this.setData({ lastMilestoneDay: milestone.day });
      }
      break;
    }
  }
}
```

### 3. 庆祝弹窗显示

```javascript
// 显示里程碑庆祝
showMilestoneCelebration(milestone) {
  this.setData({
    showMilestone: true,
    milestone: milestone
  });
}
```

## 触发时机

- **组件加载时**: `attached()` 生命周期函数中调用 `calculateProgress()`
- **页面显示时**: `pageLifetimes.show()` 中调用 `calculateProgress()`
- **用户信息更新时**: 监听 `userProfileUpdated` 事件

## 界面展示

### 庆祝弹窗结构
```xml
<!-- 里程碑庆祝 -->
<view class="milestone-celebration" wx:if="{{showMilestone}}">
  <view class="celebration-content">
    <text class="celebration-emoji">🎉</text>
    <text class="celebration-title">{{milestone.title}}</text>
    <text class="celebration-desc">{{milestone.description}}</text>
    <button class="celebration-btn" bindtap="closeCelebration">太棒了！</button>
  </view>
</view>
```

### 样式特性
- 全屏遮罩层显示
- 弹窗居中动画效果
- 表情符号弹跳动画
- 渐变按钮设计

## 数据存储

### 用户数据结构
```javascript
userData = {
  profile: {
    nickname: '用户',
    avatar: '',
    targetWeight: 60,
    currentWeight: 65,
    initialWeight: 70,
    height: 170,
    targetDate: '',
    plan: '',
    planStartDate: '2025-10-08'  // 新增字段，记录计划开始日期
  },
  records: {
    exercise: [],
    diet: [],
    weight: []
  }
}
```

## 问题修复历史

### 问题1：每天都是"开始之旅"
**原因**: 
- 数据初始化时没有设置 `planStartDate` 字段
- 每次计算天数时都使用当天作为开始日期

**解决方案**:
- 在 `app.js` 初始化用户数据时添加 `planStartDate: app.formatDate(new Date())`

### 问题2：里程碑检测错误
**原因**:
- 错误地将连续打卡天数传递给里程碑检测函数

**解决方案**:
- 将 `this.checkMilestones(consecutiveDays)` 改为 `this.checkMilestones(persistenceDays)`

### 问题3：庆祝弹窗不显示
**原因**:
- 里程碑条件判断过严：`this.data.lastMilestoneDay < milestone.day`

**解决方案**:
- 移除过严的条件判断
- 添加第1天里程碑只显示一次的逻辑

## 使用说明

1. **首次使用**:
   - 用户第一次打开小程序并进入个人资料页面时，会看到欢迎提示
   - 提示用户完善个人信息和减肥计划以获得更准确的建议
   - 用户确认后，系统会标记为非首次使用
   - 随后会显示"开始之旅"庆祝弹窗

2. **持续使用**: 系统会记录计划开始日期，天数会正常累计
3. **里程碑触发**: 达到特定天数时会自动显示对应的庆祝弹窗
4. **弹窗关闭**: 点击"太棒了！"按钮关闭庆祝弹窗

## 设计目的

- **增强用户动力**: 通过阶段性成就庆祝激励用户坚持
- **提供正向反馈**: 让用户感受到进步和成就
- **建立使用习惯**: 通过里程碑系统培养持续打卡的习惯
- **提升用户体验**: 增加趣味性和互动性

## 新增功能：首次使用欢迎提示

### 功能概述
新增了首次使用欢迎提示功能，为第一次使用小程序的用户提供友好的引导。

### 技术实现
1. **首次使用检测** (`app.js`)
   ```javascript
   // 在初始化用户数据时添加首次使用标志
   userData = {
     profile: {
       // ...其他字段...
       isFirstTime: true  // 首次使用标志
     }
   }
   ```

2. **欢迎提示显示** (`pages/profile/profile.js`)
   ```javascript
   // 检查是否是首次使用
   if (finalProfile.isFirstTime) {
     setTimeout(() => {
       this.showFirstTimeWelcome();
     }, 1000);
   }

   // 显示欢迎提示
   showFirstTimeWelcome: function() {
     wx.showModal({
       title: '欢迎使用减肥记录小程序',
       content: '欢迎！为了更好地为您服务，请先完善您的个人信息和减肥计划...',
       showCancel: false,
       confirmText: '知道了'
     });
   }
   ```

3. **与"开始之旅"协调** (`components/user-progress/user-progress.js`)
   ```javascript
   // 首次使用用户延迟显示"开始之旅"庆祝
   if (isFirstTime) {
     setTimeout(() => {
       this.showMilestoneCelebration(milestone);
     }, 2000);
   }
   ```

### 用户体验流程
1. 首次用户进入个人资料页面
2. 显示欢迎提示（1秒延迟）
3. 用户点击"知道了"确认
4. 显示"开始之旅"庆祝弹窗（2秒延迟）

## 注意事项

- 第1天的里程碑只会显示一次，避免重复打扰用户
- 里程碑基于减肥计划开始天数，不是连续打卡天数
- 系统会自动保存计划开始日期，确保天数计算准确
- 庆祝弹窗可以手动关闭，不会强制用户观看
- 首次使用欢迎提示与"开始之旅"庆祝有协调的显示时机