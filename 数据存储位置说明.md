# 数据存储位置说明

## 概述

小花助手打卡小程序使用微信小程序的本地存储功能来保存用户数据，包括用户个人信息、运动记录、饮食记录和体重记录等。本文档详细说明了数据存储的位置、结构和操作方法。

## 存储位置

### 本地存储路径

微信小程序的本地存储数据保存在设备的特定位置：

```
// 微信小程序本地存储路径
wx.setStorageSync('userData', userData);
wx.getStorageSync('userData');
```

### 存储键名

- **主数据键**: `userData`
- **全局配置键**: `globalConfig`

## 📊 数据结构详解

### 完整数据结构
```javascript
{
  "profile": {
    "nickname": "用户昵称",
    "avatar": "头像路径",
    "targetWeight": 60,        // 目标体重(kg)
    "currentWeight": 65,      // 当前体重(kg)
    "height": 170,           // 身高(cm)
    "targetDate": "2024-06-01", // 目标日期
    "plan": "减肥计划描述"       // 减肥计划
  },
  "records": {
    "exercise": [             // 运动记录数组
      {
        "id": 1234567890,      // 唯一标识
        "type": "跑步",          // 运动类型
        "duration": 30,         // 时长(分钟)
        "calories": 200,        // 消耗卡路里(可选)
        "notes": "感觉很好",      // 备注(可选)
        "date": "2024-01-01",    // 记录日期
        "timestamp": 1234567890  // 时间戳
      }
    ],
    "diet": [                // 饮食记录数组
      {
        "id": 1234567890,
        "mealType": "breakfast",  // 餐次类型
        "mealTypeText": "早餐",
        "foodName": "燕麦粥",
        "portion": 100,           // 份量(克)
        "calories": 150,         // 卡路里(可选)
        "notes": "很健康",        // 备注(可选)
        "date": "2024-01-01",
        "timestamp": 1234567890
      }
    ],
    "weight": [               // 体重记录数组
      {
        "id": 1234567890,
        "weight": 64.5,         // 体重(kg)
        "notes": "早上空腹",      // 备注(可选)
        "date": "2024-01-01",
        "timestamp": 1234567890
      }
    ]
  }
}
```

## 🔍 存储位置详细信息

### 1. 物理位置
```
微信客户端本地存储
├── 微信应用数据目录
    ├── 小程序AppID目录
        ├── userData (我们的主数据文件)
        ├── 其他系统文件
        └── 缓存文件
```

### 2. 存储方式
- **API**: `wx.getStorageSync('userData')` / `wx.setStorageSync('userData', data)`
- **类型**: 同步存储
- **格式**: JSON字符串
- **大小限制**: 单个小程序最多10MB

### 3. 数据访问方式

#### 读取数据
```javascript
// app.js中的getUserData()方法
getUserData() {
  try {
    return wx.getStorageSync('userData') || {};
  } catch (e) {
    console.error('获取用户数据失败', e);
    return {};
  }
}
```

#### 保存数据
```javascript
// app.js中的saveUserData()方法
saveUserData(userData) {
  try {
    wx.setStorageSync('userData', userData);
    return true;
  } catch (e) {
    console.error('保存用户数据失败', e);
    return false;
  }
}
```

#### 添加记录
```javascript
// app.js中的addRecord()方法
addRecord(type, record) {
  let userData = this.getUserData();
  record.id = Date.now();
  record.date = this.formatDate(new Date());
  userData.records[type].unshift(record);
  this.saveUserData(userData);
  return true;
}
```

## 🗂️ 数据生命周期

### 初始化
- **时机**: 小程序首次启动时（app.js的onLaunch方法）
- **触发**: 检测本地存储中是否存在"userData"
- **结果**: 不存在则创建默认数据结构

### 读取
- **触发**: 页面加载、数据计算、用户操作时
- **方法**: `app.getUserData()`
- **返回**: JSON对象

### 修改
- **触发**: 用户添加、删除、修改记录时
- **方法**: `app.addRecord()` → `app.saveUserData()`
- **结果**: 立即保存到本地存储

### 同步
- **触发**: 页面显示、数据刷新时
- **方法**: `app.getUserData()`
- **特点**: 从本地存储读取最新数据

## 📱 存储限制和特性

### 容量限制
- **单个小程序**: 10MB
- **所有小程序共享**: 系统级限制
- **超出限制**: 会抛出异常

### 持久性
- **应用卸载**: 数据会丢失
- **微信更新**: 数据保留
- **清理缓存**: 数据保留
- **设备更换**: 数据丢失（不同设备）

### 安全性
- **本地存储**: 只有本小程序可访问
- **网络传输**: 不涉及网络传输
- **加密**: 需要自行实现（如果需要）

## 🛠 数据管理功能

### 1. 自动初始化
```javascript
// app.js - 自动创建初始数据结构
if (!userData) {
  userData = {
    profile: { /* 默认用户信息 */ },
    records: {
      exercise: [],
      diet: [],
      weight: []
    }
  };
}
```

### 2. 错误处理
```javascript
try {
  const userData = wx.getStorageSync('userData');
  return userData || {};
} catch (e) {
  console.error('获取数据失败', e);
  return {};
}
```

### 3. 数据导出
在个人中心提供数据导出功能，将数据转换为JSON字符串。

### 4. 数据清空
在个人中心提供清空数据功能，重置为初始状态。

## 🔍 如何查看实际存储的数据

### 方法1: 开发者工具
1. 打开微信开发者工具
2. 在Console中输入：`wx.getStorageSync('userData')`
3. 查看返回的数据内容

### 方法2: 代码中查看
在任何页面的JavaScript代码中添加：
```javascript
console.log('当前数据:', wx.getStorageSync('userData'));
```

### 方法3. 导出功能
使用个人中心的"导出数据"功能，将数据复制到剪贴板。

## 📊 数据统计

### 记录数量
- **运动记录**: 无限制（受10MB总容量限制）
- **饮食记录**: 无限制
- **体重记录**: 无限制
- **实际容量**: 理论上可存储数千条记录

### 存储效率
- **单条记录**: 约200-500字节
- **1000条记录**: 约200-500KB
- **10000条记录**: 约2-5MB
- **容量利用率**: 通常低于1MB

## 💡 数据管理建议

### 1. 定期备份
- 使用导出功能定期备份数据
- 避免数据丢失风险

### 2. 数据清理
- 定期清理不需要的历史记录
- 保持数据在合理范围内

### 3. 优化存储
- 避免存储大量冗余数据
- 使用压缩算法（如果需要）

### 4. 隐私保护
- 数据仅存储在用户设备本地
- 不会上传到服务器
- 用户隐私得到保护

---

**总结**: 数据存储在微信小程序的本地存储中，使用'userData'作为键名，总容量限制为10MB，完全本地化，保护用户隐私。